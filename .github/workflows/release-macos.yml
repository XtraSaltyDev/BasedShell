name: Release macOS

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      publish:
        description: Publish artifacts to GitHub Releases
        required: true
        type: boolean
        default: true
      channel:
        description: Update channel for published artifacts
        required: true
        type: choice
        default: latest
        options:
          - latest
          - beta

permissions:
  contents: write

jobs:
  release-macos:
    runs-on: macos-14
    timeout-minutes: 60
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      CSC_LINK: ${{ secrets.CSC_LINK }}
      CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm

      - name: Install dependencies
        run: npm install

      - name: Resolve release mode
        shell: bash
        run: |
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            echo "PUBLISH=true" >> "$GITHUB_ENV"
            if [[ "${GITHUB_REF_NAME}" == *"-"* ]]; then
              echo "CHANNEL=beta" >> "$GITHUB_ENV"
              echo "RELEASE_TYPE=prerelease" >> "$GITHUB_ENV"
            else
              echo "CHANNEL=latest" >> "$GITHUB_ENV"
              echo "RELEASE_TYPE=release" >> "$GITHUB_ENV"
            fi
          else
            if [[ "${{ inputs.publish }}" == "true" ]]; then
              echo "PUBLISH=true" >> "$GITHUB_ENV"
            else
              echo "PUBLISH=false" >> "$GITHUB_ENV"
            fi
            echo "CHANNEL=${{ inputs.channel }}" >> "$GITHUB_ENV"
            if [[ "${{ inputs.channel }}" == "latest" ]]; then
              echo "RELEASE_TYPE=release" >> "$GITHUB_ENV"
            else
              echo "RELEASE_TYPE=prerelease" >> "$GITHUB_ENV"
            fi
          fi

      - name: Validate release secrets
        if: env.PUBLISH == 'true'
        shell: bash
        run: |
          required=(GH_TOKEN CSC_LINK CSC_KEY_PASSWORD APPLE_ID APPLE_APP_SPECIFIC_PASSWORD APPLE_TEAM_ID)
          missing=()
          for key in "${required[@]}"; do
            if [[ -z "${!key:-}" ]]; then
              missing+=("$key")
            fi
          done

          if (( ${#missing[@]} > 0 )); then
            printf 'Missing required secrets: %s\n' "${missing[*]}"
            exit 1
          fi

      - name: Typecheck
        run: npm run typecheck

      - name: Build app
        run: npm run build

      - name: Package only (no publish)
        if: env.PUBLISH != 'true'
        run: npx electron-builder --mac --config electron-builder.yml --publish never

      - name: Package and publish
        if: env.PUBLISH == 'true'
        shell: bash
        run: |
          if [[ "$CHANNEL" == "latest" ]]; then
            npx electron-builder --mac --config electron-builder.yml --publish always
          else
            npx electron-builder --mac --config electron-builder.yml --publish always \
              -c.publish.channel="$CHANNEL" \
              -c.publish.releaseType="$RELEASE_TYPE"
          fi

      - name: Upload release artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: basedshell-macos-artifacts
          path: release/*
          if-no-files-found: ignore
